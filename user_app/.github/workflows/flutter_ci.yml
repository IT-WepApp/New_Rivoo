name: Flutter CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  analyze_and_test:
    name: تحليل الكود والاختبارات
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./user_app
    
    steps:
      - uses: actions/checkout@v3
      
      - name: إعداد Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          cache: true
      
      - name: تثبيت التبعيات
        run: flutter pub get
      
      - name: تحليل الكود
        run: flutter analyze
      
      - name: تشغيل اختبارات الوحدة
        run: flutter test --coverage
      
      - name: تحميل تقرير التغطية
        uses: codecov/codecov-action@v3
        with:
          file: ./user_app/coverage/lcov.info
          fail_ci_if_error: false
      
      - name: تشغيل اختبارات التكامل
        run: flutter test integration_test
        
  build_android:
    name: بناء تطبيق Android
    needs: analyze_and_test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./user_app
    
    steps:
      - uses: actions/checkout@v3
      
      - name: إعداد Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: إعداد Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          cache: true
      
      - name: تثبيت التبعيات
        run: flutter pub get
      
      - name: بناء APK للتصحيح
        run: flutter build apk --debug
      
      - name: بناء APK للإصدار
        run: flutter build apk --release
      
      - name: بناء حزمة تطبيق Android (AAB)
        run: flutter build appbundle --release
      
      - name: أرشفة ملفات APK
        uses: actions/upload-artifact@v3
        with:
          name: release-apk
          path: user_app/build/app/outputs/flutter-apk/app-release.apk
      
      - name: أرشفة ملفات AAB
        uses: actions/upload-artifact@v3
        with:
          name: release-aab
          path: user_app/build/app/outputs/bundle/release/app-release.aab
  
  build_ios:
    name: بناء تطبيق iOS
    needs: analyze_and_test
    runs-on: macos-latest
    defaults:
      run:
        working-directory: ./user_app
    
    steps:
      - uses: actions/checkout@v3
      
      - name: إعداد Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          cache: true
      
      - name: تثبيت التبعيات
        run: flutter pub get
      
      - name: بناء iOS للتصحيح
        run: flutter build ios --debug --no-codesign
      
      - name: بناء iOS للإصدار (بدون توقيع)
        run: |
          flutter build ios --release --no-codesign
          cd build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload
          zip -r app-release.ipa Payload
      
      - name: أرشفة ملفات IPA
        uses: actions/upload-artifact@v3
        with:
          name: unsigned-ipa
          path: user_app/build/ios/iphoneos/app-release.ipa
  
  deploy_firebase:
    name: نشر التطبيق على Firebase App Distribution
    needs: build_android
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: تنزيل APK
        uses: actions/download-artifact@v3
        with:
          name: release-apk
          path: apk
      
      - name: نشر على Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.CREDENTIAL_FILE_CONTENT }}
          groups: testers
          file: apk/app-release.apk
          releaseNotes: |
            تم النشر تلقائياً من خلال GitHub Actions
            الفرع: ${{ github.ref_name }}
            الالتزام: ${{ github.sha }}
  
  notify_slack:
    name: إرسال إشعار إلى Slack
    needs: [build_android, build_ios]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: إرسال إشعار إلى Slack
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
          mention: 'here'
          if_mention: failure
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()

  crashlytics_upload:
    name: رفع رموز التصحيح إلى Crashlytics
    needs: build_android
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: تنزيل APK
        uses: actions/download-artifact@v3
        with:
          name: release-apk
          path: apk
      
      - name: إعداد Firebase CLI
        run: npm install -g firebase-tools
      
      - name: استخراج رموز التصحيح
        run: |
          unzip -q apk/app-release.apk -d apk_contents
          ls -la apk_contents
      
      - name: رفع رموز التصحيح إلى Crashlytics
        run: |
          firebase crashlytics:symbols:upload --app=${{ secrets.FIREBASE_APP_ID }} apk_contents
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
